buildscript {
    repositories {
        jcenter()
        maven {
            url "https://oss.sonatype.org/content/repositories/snapshots/"
        }
    }

    dependencies {
        classpath 'com.jfrog.bintray.gradle:gradle-bintray-plugin:1.6'
        classpath 'nl.javadude.gradle.plugins:license-gradle-plugin:latest.release'
    }
}

plugins {
    id 'nebula.optional-base' version '3.0.3'
    id 'me.champeau.gradle.jmh' version '0.3.1'
}

allprojects {
    group = 'com.optimizely.ab'
    apply plugin: 'idea'
}

apply from: 'gradle/license.gradle'
apply from: 'gradle/publish.gradle'

allprojects {
    def travis_defined_version = System.getenv('TRAVIS_TAG')
    if (travis_defined_version != null) {
        version = travis_defined_version
    }
}

subprojects {
    apply plugin: 'com.jfrog.bintray'
    apply plugin: 'findbugs'
    apply plugin: 'java'
    apply plugin: 'jacoco'
    apply plugin: 'maven-publish'
    apply plugin: 'me.champeau.gradle.jmh'
    apply plugin: 'nebula.provided-base'
    apply plugin: 'nebula.optional-base'

    sourceCompatibility = 1.6
    targetCompatibility = 1.6

    repositories {
        jcenter()
    }

    task sourcesJar(type: Jar, dependsOn: classes) {
        classifier = 'sources'
        from sourceSets.main.allSource
    }

    task javadocJar(type: Jar, dependsOn: javadoc) {
        classifier = 'javadoc'
        from javadoc.destinationDir
    }

    artifacts {
        archives sourcesJar
        archives javadocJar
    }

    tasks.withType(FindBugs) {
        reports {
            xml.enabled = false
            html.enabled = true
        }
    }

    test {
        useJUnit {
            excludeCategories 'com.optimizely.ab.categories.ExhaustiveTest'
        }

        testLogging {
            showStandardStreams = false
        }
    }

    task exhaustiveTest(type: Test) {
        useJUnit {
            includeCategories 'com.optimizely.ab.categories.ExhaustiveTest'
        }
    }

    jmh {
        duplicateClassesStrategy = 'warn'
    }

    sourceSets {
        jmh.java.srcDirs += sourceSets.test.java.srcDirs
    }

    dependencies {
        afterEvaluate {
            jmh configurations.testCompile.allDependencies
        }
    }

    dependencies {
        testCompile group: 'junit', name: 'junit', version: junitVersion
        testCompile group: 'org.mockito', name: 'mockito-core', version: mockitoVersion
        testCompile group: 'org.hamcrest', name: 'hamcrest-all', version: hamcrestVersion
        testCompile group: 'com.google.guava', name: 'guava', version: guavaVersion

        // logging dependencies (logback)
        testCompile group: 'ch.qos.logback', name: 'logback-classic', version: logbackVersion
        testCompile group: 'ch.qos.logback', name: 'logback-core', version: logbackVersion
    }

    publishing {
        publications {
            mavenJava(MavenPublication) {
                from components.java
                artifact sourcesJar
                artifact javadocJar
                pom.withXml {
                    asNode().children().last() + {
                        resolveStrategy = Closure.DELEGATE_FIRST
                        url 'https://github.com/optimizely/java-sdk'
                        licenses {
                            license {
                                name 'The Apache Software License, Version 2.0'
                                url 'http://www.apache.org/license/LICENSE-2.0.txt'
                                distribution 'repo'
                            }
                        }
                        developers {
                            developer {
                                id 'optimizely'
                                name 'Optimizely'
                                email 'developers@optimizely.com'
                            }
                        }
                    }
                }
            }
        }
    }

    def bintrayName = 'core-api';
    if (name.equals('core-httpclient-impl')) {
        bintrayName = 'httpclient'
    }

    bintray {
        user = System.getenv('BINTRAY_USER')
        key = System.getenv('BINTRAY_KEY')
        pkg {
            repo = 'optimizely'
            name = "optimizely-sdk-${bintrayName}"
            userOrg = 'optimizely'
            version {
                name = rootProject.version
            }
            publications = ['mavenJava']
        }
    }

    build.dependsOn('generatePomFileForMavenJavaPublication')

    bintrayUpload.dependsOn 'build'

    task ship() {
        dependsOn('bintrayUpload')
    }
}

task ship() {
    dependsOn(':core-api:ship', ':core-httpclient-impl:ship')
}

// todo: remove this wrapper version once we're publishing to jcenter/maven central
task wrapper(type: Wrapper) {
    distributionUrl = gradleWrapperUrl
}
