language: android
sudo: required
jdk: oraclejdk8

env:
 global:
# These parameters should match the parameters for build tools and sdk versions in the gradle file
 - ANDROID_API_LEVEL=29
 - ANDROID_BUILD_TOOLS_VERSION=29.0.3
 - ANDROID_ABI=armeabi-v7a
 matrix:
 - EMULATOR_API=19 # API-16 build fails in travis
 - EMULATOR_API=21
 - EMULATOR_API=29
android:
  components:
    - tools
    - platform-tools
before_cache:
  - rm -f $HOME/.gradle/caches/modules-2/modules-2.lock
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
before_install:
  - mkdir -p $HOME/.android && touch $HOME/.android/repositories.cfg
  - yes | sdkmanager "platforms;android-$ANDROID_API_LEVEL"
  - yes | sdkmanager "build-tools;$ANDROID_BUILD_TOOLS_VERSION"
before_script:
  - echo $TRAVIS_BRANCH
  - echo $TRAVIS_TAG
  - echo no | android create avd --force -n test -t android-$EMULATOR_API --abi $ANDROID_ABI || sdkmanager --list
  - emulator -avd test -no-audio -no-window &
  - scripts/android-wait-for-emulator.sh
  - adb shell input keyevent 82 &
script:
  - ./gradlew cleanAllModules
  - ./gradlew testAllModulesTravis

# Integration tests need to run first to reset the PR build status to pending
stages:
  - 'Source Clear'
  - 'Lint markdown files'
  - 'Integration tests'
  - 'Test'
  - 'Publish'

jobs:
  include:
    - stage: 'Lint markdown files'
      os: linux
      language: generic
      install: gem install awesome_bot
      before_script: skip
      script:
        - find . -type f -name '*.md' -exec awesome_bot {} \;
      notifications:
        email: false

    - stage: 'Integration tests'
      env:
        - SDK=android
        - BUILD_NUMBER=${TRAVIS_JOB_NUMBER/.}
        - SDK_BRANCH=$TRAVIS_PULL_REQUEST_BRANCH
        - TESTAPP_BRANCH=master
      cache: false
      language: minimal
      before_install: skip
      install: skip
      before_script:
        - mkdir $HOME/travisci-tools && pushd $HOME/travisci-tools && git init && git pull https://$CI_USER_TOKEN@github.com/optimizely/travisci-tools.git && popd
      script:
        - $HOME/travisci-tools/trigger-script-with-status-update.sh
      after_success: travis_terminate 0

    - stage: 'Source Clear'
      if: type = cron
      addons:
        srcclr: true
      before_install: skip
      install: skip
      before_script: skip
      script: skip
      after_script: skip
      after_success: skip

    - stage: 'Publish'
      if: tag IS present
      script:
        - ./gradlew ship
      after_script: skip
      after_success: skip
